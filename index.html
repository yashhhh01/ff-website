<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>OPERA ESPORTS — Preview</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React + ReactDOM UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX in-browser (preview only) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      /* small helper */
      .glass { background: rgba(255,255,255,0.75); backdrop-filter: blur(6px); }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-to-r from-pink-300 via-purple-300 to-indigo-300">
    <div id="root" class="p-6"></div>

    <script type="text/babel">
    const { useState, useEffect } = React;

    const PHONE = "9305659871";
    const EMAIL = "hvssingh4@gmail.com";
    const WHATSAPP_GROUP = "https://chat.whatsapp.com/E2EPeg3FAml2zYlM3xPdU9?mode=wwc";
    const WHATSAPP_CONTACT = `https://wa.me/91${PHONE}`;
    const UPI_ID = "9305659871@omni";
    const PERMANENT_QR = "{QR_PLACEHOLDER}";
    const ADMIN_USER = "harsh_v.singh";
    const ADMIN_PASS = "shrijaislobe";
    const MAX_PER_SLOT = 2;

    // generate 10:00 to 20:00 slots, every 30 min
    function generateSlots() {
      const slots = [];
      const start = new Date();
      start.setHours(10,0,0,0);
      for (let i=0; i<24; i++){
        const d = new Date(start.getTime() + i*30*60*1000);
        if (d.getHours() > 20 || (d.getHours()===20 && d.getMinutes()>0)) break;
        slots.push(d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
      }
      return slots;
    }
    const ALL_SLOTS = generateSlots();

    function useLocalStorage(key, initial) {
      const [state, setState] = useState(() => {
        try {
          const s = localStorage.getItem(key);
          return s ? JSON.parse(s) : initial;
        } catch (e) {
          return initial;
        }
      });
      useEffect(() => {
        try { localStorage.setItem(key, JSON.stringify(state)); } catch (e) {}
      }, [key, state]);
      return [state, setState];
    }

    function App() {
      const [route, setRoute] = useState(window.location.hash || "#/");
      useEffect(() => {
        const onHash = () => setRoute(window.location.hash || "#/");
        window.addEventListener("hashchange", onHash);
        return () => window.removeEventListener("hashchange", onHash);
      }, []);
      return (
        <div className="min-h-screen">
          <Header />
          <div className="max-w-5xl mx-auto mt-6">
            {route === "#/admin" ? <AdminApp /> :
             route.startsWith("#/payment/") ? <PaymentView bookingId={route.split("/payment/")[1]} /> :
             route.startsWith("#/success/") ? <SuccessView bookingId={route.split("/success/")[1]} /> :
             <Home />}
          </div>
          <Footer />
        </div>
      );
    }

    function Header(){
      return (
        <header className="flex items-center justify-between px-4 py-3">
          <div className="flex items-center gap-3">
            <div className="text-2xl font-extrabold">OPERA ESPORTS</div>
            <div className="text-sm text-slate-800/80">Free Fire — Clash Squad Paid Scrims</div>
          </div>
          <div className="flex items-center gap-3">
            <a href={WHATSAPP_GROUP} target="_blank" rel="noreferrer" className="px-3 py-1 bg-white/80 rounded shadow text-sm">Join WhatsApp Group</a>
            <a href="#/admin" className="px-3 py-1 bg-white/80 rounded shadow text-sm">Admin</a>
          </div>
        </header>
      );
    }

    // ---- HOME (User) ----
    function Home(){
      const [bookings, setBookings] = useLocalStorage("opera_bookings", []);
      const [form, setForm] = useState({
        playerIGN: "",
        playerUID: "",
        teamName: "",
        slot: ALL_SLOTS[0] || "",
        amount: 50,
        mode: "Solo",
        throwables: "Limited"
      });

      const slotCounts = ALL_SLOTS.reduce((acc, s) => {
        acc[s] = bookings.filter(b => b.slot===s && b.status !== "cancelled" && b.status !== "timeout").length;
        return acc;
      }, {});

      function setField(k,v){
        setForm(prev => ({...prev, [k]: v}));
      }

      function numericUIDChange(e){
        const v = e.target.value;
        if (v === "" || /^[0-9]*$/.test(v)) setField("playerUID", v);
      }

      function proceed(e){
        e.preventDefault();
        if (!form.playerIGN || !form.playerUID){
          return alert("Fill Player IGN and numeric Player UID.");
        }
        if (!form.slot) return alert("Select a slot.");
        if ((slotCounts[form.slot]||0) >= MAX_PER_SLOT) return alert("Slot full. Choose another.");
        const id = "bk_"+Date.now();
        const newB = {...form, id, createdAt: Date.now(), status: "pending_payment"};
        setBookings([...bookings, newB]);
        window.location.hash = `#/payment/${id}`;
      }

      return (
        <main className="p-6 glass rounded-2xl shadow-lg">
          <div className="grid md:grid-cols-3 gap-6">
            <div className="md:col-span-2">
              <h2 className="text-xl font-bold mb-2">Book a Slot</h2>
              <p className="mb-4 text-sm">Fill details and proceed to payment. Send payment screenshot to WhatsApp number after paying — admin will verify.</p>

              <form onSubmit={proceed} className="space-y-3">
                <div className="grid md:grid-cols-2 gap-3">
                  <label className="block">
                    <div className="text-sm">Player IGN</div>
                    <input className="w-full p-2 rounded border" value={form.playerIGN} onChange={e=>setField("playerIGN", e.target.value)} />
                  </label>
                  <label className="block">
                    <div className="text-sm">Player UID (numbers only)</div>
                    <input className="w-full p-2 rounded border" value={form.playerUID} onChange={numericUIDChange} />
                  </label>
                </div>

                <label className="block">
                  <div className="text-sm">Team Name</div>
                  <input className="w-full p-2 rounded border" value={form.teamName} onChange={e=>setField("teamName", e.target.value)} />
                </label>

                <div className="grid md:grid-cols-3 gap-3">
                  <label>
                    <div className="text-sm">Select Slot</div>
                    <select className="w-full p-2 rounded border" value={form.slot} onChange={e=>setField("slot", e.target.value)}>
                      {ALL_SLOTS.map(s => (
                        <option key={s} value={s} disabled={(slotCounts[s]||0) >= MAX_PER_SLOT}>
                          {s} {(slotCounts[s]||0) >= MAX_PER_SLOT ? "(Full)" : `(${MAX_PER_SLOT - (slotCounts[s]||0)} left)`}
                        </option>
                      ))}
                    </select>
                  </label>

                  <label>
                    <div className="text-sm">Team Mode</div>
                    <select className="w-full p-2 rounded border" value={form.mode} onChange={e=>setField("mode", e.target.value)}>
                      <option>Solo</option><option>Duo</option><option>Squad</option>
                    </select>
                  </label>

                  <label>
                    <div className="text-sm">Throwables</div>
                    <div className="flex gap-2">
                      <button type="button" className={`px-3 py-2 rounded ${form.throwables==='Limited' ? 'bg-indigo-600 text-white' : 'bg-white border'}`} onClick={()=>setField("throwables","Limited")}>Limited</button>
                      <button type="button" className={`px-3 py-2 rounded ${form.throwables==='Unlimited' ? 'bg-indigo-600 text-white' : 'bg-white border'}`} onClick={()=>setField("throwables","Unlimited")}>Unlimited</button>
                    </div>
                  </label>
                </div>

                <div className="grid md:grid-cols-2 gap-3">
                  <label>
                    <div className="text-sm">Entry Amount (₹)</div>
                    <select className="w-full p-2 rounded border" value={form.amount} onChange={e=>setField("amount", Number(e.target.value))}>
                      {[50,100,150,200,250,300].map(a=> <option key={a} value={a}>{a}</option>)}
                    </select>
                  </label>

                  <div className="p-3 rounded border">
                    <div className="text-sm">Winning Amount</div>
                    <div className="text-xl font-bold">₹{(form.amount*1.8).toFixed(2)}</div>
                  </div>
                </div>

                <div className="flex items-center gap-3">
                  <button className="px-4 py-2 bg-emerald-500 text-white rounded">Proceed to Payment</button>
                  <a className="text-sm text-slate-700" href={WHATSAPP_GROUP} target="_blank" rel="noreferrer">Join WhatsApp group</a>
                </div>
              </form>
            </div>

            <aside className="space-y-4">
              <div className="p-4 rounded border">
                <h3 className="font-semibold">Customer Service</h3>
                <p className="text-sm">Phone: {PHONE}</p>
                <p className="text-sm">Email: {EMAIL}</p>
                <p className="text-sm">WhatsApp Group: <a className="underline" href={WHATSAPP_GROUP} target="_blank" rel="noreferrer">Join</a></p>
              </div>

              <div className="p-4 rounded border">
                <h3 className="font-semibold">Live Slots</h3>
                <div className="text-sm max-h-48 overflow-auto mt-2">
                  {ALL_SLOTS.map(s => (
                    <div key={s} className="flex justify-between py-1 border-b last:border-b-0">
                      <div>{s}</div>
                      <div>{slotCounts[s]||0}/{MAX_PER_SLOT}</div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="p-4 rounded border">
                <h3 className="font-semibold">Important</h3>
                <ul className="list-disc ml-5 text-sm mt-2">
                  <li>Send payment screenshot to 9305659871 after paying (use the WhatsApp button on payment page).</li>
                  <li>Rules list will be provided by the manager after sending screenshot to manager.</li>
                  <li>Payment is verified by admin — you will be redirected to success page once verified.</li>
                  <li>No booking without payment.</li>
                  <li>Don't worry if you made the payment and slot isn't confirmed just contact the manager.</li>
                </ul>
              </div>
            </aside>
          </div>
        </main>
      );
    }

    // ---- PAYMENT VIEW ----
    function PaymentView({ bookingId }){
      const [bookings, setBookings] = useLocalStorage("opera_bookings", []);
      const booking = bookings.find(b => b.id === bookingId);
      const [timer, setTimer] = useState(5*60);

      useEffect(() => {
        if (!booking) return;
        if (booking.status === "paid" || booking.status === "approved") return;
        const t = setInterval(() => setTimer(t => t-1), 1000);
        return () => clearInterval(t);
      }, []);

      useEffect(()=>{
        if (timer <= 0 && booking && booking.status === "pending_payment"){
          const updated = bookings.map(b => b.id === booking.id ? {...b, status: "timeout"} : b);
          setBookings(updated);
          alert("Payment time expired. Booking timed out.");
          window.location.hash = "#/";
        }
      }, [timer]);

      if (!booking) return <div className="p-6">Booking not found.</div>;

      function openWhatsApp(){
        const updated = bookings.map(b => b.id === booking.id ? {...b, status: "awaiting_admin"} : b);
        setBookings(updated);
        window.open("https://wa.me/919305659871", "_blank");
      }

      return (
        <div className="p-6 glass rounded-2xl shadow-lg">
          <button className="text-sm underline mb-3" onClick={()=>window.location.hash="#/"}>← Back to Home</button>
          <h2 className="text-xl font-bold mb-2">Payment for Booking {booking.id}</h2>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <div className="p-3 rounded border mb-3">
                <div className="text-sm">Slot</div>
                <div className="font-medium">{booking.slot}</div>
              </div>
              <div className="p-3 rounded border mb-3">
                <div className="text-sm">Mode</div>
                <div className="font-medium">{booking.mode}</div>
              </div>
              <div className="p-3 rounded border">
                <div className="text-sm">Amount</div>
                <div className="font-bold text-xl">₹{booking.amount}</div>
                <div className="text-sm">Winning: ₹{(booking.amount*1.8).toFixed(2)}</div>
              </div>
            </div>

            <div>
              <div className="p-3 rounded border mb-3">
                <div className="text-sm">Pay via UPI ID</div>
                <div className="font-medium">{UPI_ID}</div>
              </div>

              <div className="p-3 rounded border mb-3">
                <div className="text-sm">Organizer QR (permanent)</div>
                <img src={PERMANENT_QR} className="w-40 h-40 object-contain mt-2 border" alt="qr" />
              </div>

              <div className="p-3 rounded border mb-3">
                <div className="text-sm">Payment timer</div>
                <div className="text-lg font-bold">{Math.floor(timer/60)}:{String(timer%60).padStart(2,'0')}</div>
              </div>

              <div className="flex gap-2">
                <button onClick={openWhatsApp} className="px-3 py-2 bg-green-600 text-white rounded">Open WhatsApp to send screenshot</button>
                <button onClick={()=>{ window.location.hash = "#/"; }} className="px-3 py-2 bg-gray-200 rounded">Cancel</button>
              </div>

              <p className="text-sm mt-3">After sending the payment screenshot to the manager you'll receive the rules list. Admin must verify and mark your booking as Paid or Declined.</p>
            </div>
          </div>
        </div>
      );
    }

    // ---- SUCCESS VIEW ----
    function SuccessView({ bookingId }){
      const [bookings] = useLocalStorage("opera_bookings", []);
      const booking = bookings.find(b => b.id === bookingId);
      if (!booking) return <div className="p-6 glass rounded">Booking not found.</div>;
      const status = booking.status;
      return (
        <div className="p-6 glass rounded-2xl shadow-lg text-center">
          {status === "approved" ? (
            <>
              <h2 className="text-2xl font-bold text-emerald-600">Payment Successful!</h2>
              <p className="mt-3">Booking confirmed for <strong>{booking.slot}</strong></p>
            </>
          ) : status === "cancelled" || status === "declined" ? (
            <>
              <h2 className="text-2xl font-bold text-red-600">Payment Declined</h2>
              <p className="mt-3">Contact the manager on WhatsApp: <a href={`https://wa.me/919305659871`} className="underline">9305659871</a></p>
            </>
          ) : (
            <>
              <h2 className="text-2xl font-bold text-amber-600">Payment recorded — awaiting admin verification</h2>
              <p className="mt-3">Admin will verify and update your booking status shortly.</p>
            </>
          )}
          <p className="mt-3">Player IGN: {booking.playerIGN} | UID: {booking.playerUID}</p>
          <p className="mt-2">Team: {booking.teamName || '—'}</p>
          <a className="underline mt-3 block" href={WHATSAPP_GROUP} target="_blank" rel="noreferrer">Join WhatsApp Group</a>
        </div>
      );
    }

    // ---- ADMIN APP ----
    function AdminApp(){
      const [bookings, setBookings] = useLocalStorage("opera_bookings", []);
      const [auth, setAuth] = useLocalStorage("opera_admin_auth", { logged:false });
      const [user, setUser] = useState("");
      const [pass, setPass] = useState("");
      const [loggedIn, setLoggedIn] = useState(auth.logged || false);

      useEffect(()=> { setLoggedIn(auth.logged || false); }, [auth]);

      function tryLogin(e){
        e.preventDefault();
        if (user === ADMIN_USER && pass === ADMIN_PASS){
          setAuth({ logged:true });
          setLoggedIn(true);
        } else {
          alert("Invalid credentials");
        }
      }

      function logout(){
        setAuth({ logged:false });
        setLoggedIn(false);
        window.location.hash = "#/";
      }

      function markPaid(id){
        const updated = bookings.map(b => b.id === id ? {...b, status: "approved"} : b);
        setBookings(updated);
        alert("Marked approved.");
      }
      function declineBooking(id){
        const updated = bookings.map(b => b.id === id ? {...b, status: "declined"} : b);
        setBookings(updated);
      }
      function cancelBooking(id){
        const updated = bookings.map(b => b.id === id ? {...b, status: "cancelled"} : b);
        setBookings(updated);
      }

      if (!loggedIn){
        return (
          <div className="p-6 glass rounded-2xl max-w-md mx-auto">
            <h3 className="text-xl font-bold mb-3">Admin Login</h3>
            <form onSubmit={tryLogin} className="space-y-3">
              <input value={user} onChange={e=>setUser(e.target.value)} placeholder="username" className="w-full p-2 rounded border" />
              <input value={pass} onChange={e=>setPass(e.target.value)} placeholder="password" type="password" className="w-full p-2 rounded border" />
              <div className="flex gap-2">
                <button className="px-3 py-2 bg-indigo-600 text-white rounded">Login</button>
              </div>
            </form>
          </div>
        );
      }

      return (
        <div className="p-6 glass rounded-2xl">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-xl font-bold">Admin Dashboard</h3>
            <div className="flex gap-2 items-center">
              <div className="text-sm">Organizer QR (permanent)</div>
              <button onClick={logout} className="px-3 py-1 bg-gray-200 rounded">Logout</button>
            </div>
          </div>

          <div className="overflow-auto max-h-96">
            <table className="w-full table-auto border">
              <thead className="bg-slate-100">
                <tr>
                  <th className="p-2 text-left">ID</th>
                  <th className="p-2 text-left">IGN</th>
                  <th className="p-2 text-left">UID</th>
                  <th className="p-2 text-left">Team</th>
                  <th className="p-2 text-left">Slot</th>
                  <th className="p-2 text-left">Mode</th>
                  <th className="p-2 text-left">Throwables</th>
                  <th className="p-2 text-left">Amt</th>
                  <th className="p-2 text-left">Status</th>
                  <th className="p-2 text-left">Actions</th>
                </tr>
              </thead>
              <tbody>
                {bookings.length === 0 && <tr><td colSpan="10" className="p-4 text-center">No bookings yet</td></tr>}
                {bookings.map(b => (
                  <tr key={b.id} className="border-b">
                    <td className="p-2">{b.id}</td>
                    <td className="p-2">{b.playerIGN}</td>
                    <td className="p-2">{b.playerUID}</td>
                    <td className="p-2">{b.teamName || '—'}</td>
                    <td className="p-2">{b.slot}</td>
                    <td className="p-2">{b.mode}</td>
                    <td className="p-2">{b.throwables}</td>
                    <td className="p-2">₹{b.amount}</td>
                    <td className="p-2">{b.status}</td>
                    <td className="p-2 space-x-2">
                      <button onClick={() => markPaid(b.id)} className="px-2 py-1 bg-green-500 text-white rounded">Approve</button>
                      <button onClick={() => declineBooking(b.id)} className="px-2 py-1 bg-yellow-500 text-white rounded">Decline</button>
                      <button onClick={() => cancelBooking(b.id)} className="px-2 py-1 bg-red-500 text-white rounded">Cancel</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          <div className="mt-4">
            <p className="text-sm">Uploaded QR will appear on payment page for users.</p>
            <img src={PERMANENT_QR} className="w-28 h-28 mt-2 border" alt="qr" />
          </div>
        </div>
      );
    }

    function Footer(){
      return (
        <footer className="text-center p-6 mt-6 text-sm">
          For any information contact {PHONE} — <a href={"mailto:"+EMAIL} className="underline">{EMAIL}</a>
        </footer>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
